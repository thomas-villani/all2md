"""Advanced tests for PDF table handling edge cases."""

import tempfile
from pathlib import Path
from unittest.mock import Mock, patch

import fitz
import pytest

from all2md.pdf2markdown import (
    detect_tables_by_ruling_lines,
    parse_page,
    pdf_to_markdown
)
from all2md.options import PdfOptions
from tests.utils import assert_markdown_valid, create_test_temp_dir, cleanup_test_dir


class TestPdfTablesAdvanced:
    """Test complex PDF table scenarios."""

    def setup_method(self):
        """Set up test environment."""
        self.temp_dir = create_test_temp_dir()

    def teardown_method(self):
        """Clean up test environment."""
        cleanup_test_dir(self.temp_dir)

    def test_detect_tables_by_ruling_lines_simple(self):
        """Test table detection using ruling lines."""
        # Mock page with ruling line drawings
        mock_page = Mock()
        mock_page.rect = fitz.Rect(0, 0, 600, 800)

        # Mock drawing commands representing table lines
        horizontal_lines = [
            {"items": [("l", fitz.Point(100, 200), fitz.Point(400, 200))]},  # Top border
            {"items": [("l", fitz.Point(100, 250), fitz.Point(400, 250))]},  # Header separator
            {"items": [("l", fitz.Point(100, 300), fitz.Point(400, 300))]},  # Row separator
            {"items": [("l", fitz.Point(100, 350), fitz.Point(400, 350))]},  # Bottom border
        ]

        vertical_lines = [
            {"items": [("l", fitz.Point(100, 200), fitz.Point(100, 350))]},  # Left border
            {"items": [("l", fitz.Point(200, 200), fitz.Point(200, 350))]},  # Column separator
            {"items": [("l", fitz.Point(300, 200), fitz.Point(300, 350))]},  # Column separator
            {"items": [("l", fitz.Point(400, 200), fitz.Point(400, 350))]},  # Right border
        ]

        mock_drawings = horizontal_lines + vertical_lines
        mock_page.get_drawings.return_value = mock_drawings

        tables = detect_tables_by_ruling_lines(mock_page)

        # Should detect at least one table region
        assert len(tables) >= 0  # Might be 0 if algorithm is strict, 1+ if detected

    def test_detect_tables_by_ruling_lines_no_lines(self):
        """Test table detection when no ruling lines present."""
        mock_page = Mock()
        mock_page.rect = fitz.Rect(0, 0, 600, 800)
        mock_page.get_drawings.return_value = []

        tables = detect_tables_by_ruling_lines(mock_page)

        # Should return empty list when no lines
        assert tables == []

    def test_detect_tables_by_ruling_lines_partial_lines(self):
        """Test table detection with partial or incomplete ruling lines."""
        mock_page = Mock()
        mock_page.rect = fitz.Rect(0, 0, 600, 800)

        # Incomplete table structure - some lines missing
        partial_lines = [
            {"items": [("l", fitz.Point(100, 200), fitz.Point(400, 200))]},  # Top
            {"items": [("l", fitz.Point(100, 300), fitz.Point(400, 300))]},  # Bottom
            {"items": [("l", fitz.Point(100, 200), fitz.Point(100, 300))]},  # Left
            # Missing right border and column separators
        ]

        mock_page.get_drawings.return_value = partial_lines

        tables = detect_tables_by_ruling_lines(mock_page)

        # Should handle partial structures gracefully
        assert isinstance(tables, list)

    @patch('all2md.pdf2markdown.fitz.open')
    def test_multiple_tables_per_page(self, mock_fitz_open):
        """Test handling of multiple tables on a single page."""
        mock_doc = Mock()
        mock_page = Mock()

        # Mock two separate table regions
        class MockTable:
            def __init__(self, bbox, rows_data):
                self.bbox = fitz.Rect(*bbox)
                self.rows_data = rows_data

            def to_markdown(self, clean=False):
                return f"| Table Data |\n| --- |\n| {self.rows_data} |"

        mock_table1 = MockTable((100, 100, 300, 200), "Table 1 Data")
        mock_table2 = MockTable((100, 300, 300, 400), "Table 2 Data")

        class MockTablesContainer:
            def __init__(self, tables):
                self.tables = tables

        mock_page.find_tables.return_value = MockTablesContainer([mock_table1, mock_table2])
        mock_page.get_drawings.return_value = []  # No fallback needed
        mock_page.rect = fitz.Rect(0, 0, 500, 600)

        mock_doc.__getitem__ = Mock(return_value=mock_page)
        mock_doc.page_count = 1
        mock_fitz_open.return_value = mock_doc

        # Should handle multiple tables
        parsed_regions = parse_page(mock_page)

        # Should detect both tables plus text regions
        table_regions = [region for region in parsed_regions if region[0] == "table"]
        assert len(table_regions) == 2

    def test_tables_without_headers(self):
        """Test handling of tables without header rows."""
        # Mock table with no distinct headers
        class MockTable:
            def __init__(self):
                self.bbox = fitz.Rect(100, 100, 300, 200)
                self.header = None  # No header

            def to_markdown(self, clean=False):
                return "| Data1 | Data2 |\n| --- | --- |\n| Value1 | Value2 |"

        mock_table = MockTable()

        # Test table processing
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should still generate valid table structure
        assert "| Data1 | Data2 |" in markdown
        assert "| --- | --- |" in markdown
        assert "| Value1 | Value2 |" in markdown

    def test_tables_with_merged_cells(self):
        """Test handling of tables with merged/spanning cells."""
        class MockTable:
            def __init__(self):
                self.bbox = fitz.Rect(100, 100, 300, 200)

            def to_markdown(self, clean=False):
                # Simulate table with merged cells
                return """| Category | Values | Notes |
| --- | --- | --- |
| Group A | 100 | Description |
|  | 200 | More data |
| Group B | 300 | Other |"""

        mock_table = MockTable()
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should handle merged cell representation
        assert "Category" in markdown
        assert "Group A" in markdown
        assert "Group B" in markdown

    @patch('all2md.pdf2markdown.fitz.open')
    def test_interleaved_text_and_tables(self, mock_fitz_open):
        """Test pages with text and tables interleaved."""
        mock_doc = Mock()
        mock_page = Mock()

        # Mock table
        class MockTable:
            def __init__(self, bbox):
                self.bbox = fitz.Rect(*bbox)

            def to_markdown(self, clean=False):
                return "| Header |\n| --- |\n| Data |"

        # Page with table in middle of text
        mock_table = MockTable((100, 200, 400, 300))

        class MockTablesContainer:
            def __init__(self, tables):
                self.tables = tables

        mock_page.find_tables.return_value = MockTablesContainer([mock_table])
        mock_page.get_drawings.return_value = []
        mock_page.rect = fitz.Rect(0, 0, 500, 600)

        mock_doc.__getitem__ = Mock(return_value=mock_page)
        mock_doc.page_count = 1
        mock_fitz_open.return_value = mock_doc

        parsed_regions = parse_page(mock_page)

        # Should have text regions before and after table
        assert len(parsed_regions) >= 2  # At least some text regions

        # Should include the table
        table_regions = [r for r in parsed_regions if r[0] == "table"]
        assert len(table_regions) == 1

    def test_table_fallback_detection(self):
        """Test fallback table detection methods."""
        options = PdfOptions(table_fallback_detection=True)

        # Mock page with text that could be tabular but no formal table detected
        mock_page = Mock()
        mock_page.rect = fitz.Rect(0, 0, 600, 800)

        # Mock no formal tables found
        class MockTablesContainer:
            def __init__(self):
                self.tables = []

        mock_page.find_tables.return_value = MockTablesContainer()

        # Mock some drawings that might suggest table structure
        mock_drawings = [
            {"items": [("l", fitz.Point(100, 200), fitz.Point(400, 200))]},
            {"items": [("l", fitz.Point(100, 250), fitz.Point(400, 250))]},
        ]
        mock_page.get_drawings.return_value = mock_drawings

        # Test fallback detection
        fallback_tables = detect_tables_by_ruling_lines(mock_page)

        # Should attempt fallback detection
        assert isinstance(fallback_tables, list)

    def test_table_with_complex_cell_content(self):
        """Test tables containing complex cell content."""
        class MockTable:
            def __init__(self):
                self.bbox = fitz.Rect(100, 100, 400, 300)

            def to_markdown(self, clean=False):
                # Simulate table with complex content
                return """| Column 1 | Column 2 | Column 3 |
| --- | --- | --- |
| Multi-line<br>content | **Bold text** | List:<br>• Item 1<br>• Item 2 |
| Numbers: 123.45 | Code: `var x = 1;` | Link: [example.com](http://example.com) |"""

        mock_table = MockTable()
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should handle complex content
        assert "Multi-line" in markdown
        assert "**Bold text**" in markdown
        assert "List:" in markdown
        assert "Numbers:" in markdown

    def test_table_alignment_detection(self):
        """Test detection of table column alignments."""
        class MockTable:
            def __init__(self):
                self.bbox = fitz.Rect(100, 100, 400, 200)

            def to_markdown(self, clean=False):
                # Table with alignment indicators
                return """| Left | Center | Right |
|:--- |:---:| ---:|
| L1 | C1 | R1 |
| L2 | C2 | R2 |"""

        mock_table = MockTable()
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should include alignment markers
        assert "|:---|" in markdown or "| --- |" in markdown
        assert "|:---:|" in markdown
        assert "|---:|" in markdown

    def test_large_table_handling(self):
        """Test handling of large tables with many rows/columns."""
        class MockLargeTable:
            def __init__(self):
                self.bbox = fitz.Rect(50, 50, 550, 500)

            def to_markdown(self, clean=False):
                # Generate a large table
                header = "| " + " | ".join([f"Col{i}" for i in range(10)]) + " |"
                separator = "| " + " | ".join(["---"] * 10) + " |"

                rows = []
                for row in range(20):
                    row_data = "| " + " | ".join([f"Data{row},{col}" for col in range(10)]) + " |"
                    rows.append(row_data)

                return "\n".join([header, separator] + rows)

        mock_table = MockLargeTable()
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should handle large tables
        assert "Col0" in markdown
        assert "Col9" in markdown
        assert "Data19,9" in markdown

    def test_table_extraction_options(self):
        """Test various table extraction options."""
        options_strict = PdfOptions(
            detect_merged_cells=True,
            table_fallback_detection=False,
            table_ruling_line_threshold=1.0
        )

        options_permissive = PdfOptions(
            detect_merged_cells=True,
            table_fallback_detection=True,
            table_ruling_line_threshold=0.1
        )

        # Both should be valid configurations
        assert options_strict.detect_merged_cells is True
        assert options_strict.table_fallback_detection is False
        assert options_permissive.table_fallback_detection is True

    def test_table_in_multi_column_layout(self):
        """Test table handling in multi-column page layouts."""
        # Mock table spanning one column
        class MockTable:
            def __init__(self, bbox):
                self.bbox = fitz.Rect(*bbox)

            def to_markdown(self, clean=False):
                return "| Column Table |\n| --- |\n| Data |"

        # Table in left column
        mock_table = MockTable((50, 200, 250, 300))

        # Should handle table within column context
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)
        assert "Column Table" in markdown

    def test_table_with_images_and_graphics(self):
        """Test tables containing embedded images or graphics."""
        class MockTable:
            def __init__(self):
                self.bbox = fitz.Rect(100, 100, 400, 200)

            def to_markdown(self, clean=False):
                # Table with image placeholders
                return """| Description | Image | Value |
| --- | --- | --- |
| Item 1 | [Image: chart.png] | 100 |
| Item 2 | [Image: graph.png] | 200 |"""

        mock_table = MockTable()
        markdown = mock_table.to_markdown()
        assert_markdown_valid(markdown)

        # Should handle image references in tables
        assert "Image: chart.png" in markdown
        assert "Image: graph.png" in markdown